type: model
description: >
  Enriched spending data joining raw claims with NPI provider details, HCPCS procedure descriptions,
  RBCS service classifications, OIG LEIE exclusion flags, and Census ACS/RUCA ZIP code demographics.
materialize: true

sql: |
  WITH providers AS (
    -- Stage 1: Raw spending + NPI provider details
    SELECT
      s.*,
      bp.provider_name AS billing_provider_name,
      bp.provider_type AS billing_provider_type,
      bp.provider_address AS billing_provider_address,
      bp.provider_city AS billing_provider_city,
      bp.provider_state AS billing_provider_state,
      bp.provider_zip AS billing_provider_zip,
      bp.authorized_official AS billing_authorized_official,
      bp.taxonomy_code AS billing_taxonomy_code,
      sp.provider_name AS servicing_provider_name,
      sp.provider_type AS servicing_provider_type,
      sp.provider_address AS servicing_provider_address,
      sp.provider_city AS servicing_provider_city,
      sp.provider_state AS servicing_provider_state,
      sp.provider_zip AS servicing_provider_zip,
      sp.authorized_official AS servicing_authorized_official,
      sp.taxonomy_code AS servicing_taxonomy_code
    FROM {{ ref "medicaid_provider_spending" }} s
    LEFT JOIN {{ ref "npi_providers" }} bp ON s.billing_provider_npi = bp.npi
    LEFT JOIN {{ ref "npi_providers" }} sp ON s.servicing_provider_npi = sp.npi
  ),

  procedures AS (
    -- Stage 2: + HCPCS descriptions + RBCS classification
    SELECT
      p.*,
      COALESCE(h.hcpcs_description, r.rbcs_family_desc) AS hcpcs_description,
      h.hcpcs_short_description,
      r.rbcs_cat_desc AS rbcs_category,
      r.rbcs_subcat_desc AS rbcs_subcategory
    FROM providers p
    LEFT JOIN {{ ref "hcpcs_codes" }} h ON p.hcpcs_code = h.hcpcs_code
    LEFT JOIN {{ ref "rbcs_codes" }} r ON p.hcpcs_code = r.hcpcs_code
  ),

  exclusions AS (
    -- Stage 3: + OIG LEIE exclusion flags
    SELECT
      pr.*,
      CASE WHEN bl.npi IS NOT NULL THEN true ELSE false END AS billing_provider_excluded,
      bl.exclusion_type AS billing_exclusion_type,
      bl.exclusion_date AS billing_exclusion_date,
      CASE WHEN sl.npi IS NOT NULL THEN true ELSE false END AS servicing_provider_excluded,
      sl.exclusion_type AS servicing_exclusion_type,
      sl.exclusion_date AS servicing_exclusion_date,
      CASE WHEN bl.npi IS NOT NULL OR sl.npi IS NOT NULL THEN true ELSE false END AS is_excluded
    FROM procedures pr
    LEFT JOIN {{ ref "leie_exclusions" }} bl ON pr.billing_provider_npi = bl.npi
    LEFT JOIN {{ ref "leie_exclusions" }} sl ON pr.servicing_provider_npi = sl.npi
  )

  -- Stage 4: + ZIP code demographics (Census ACS + RUCA)
  SELECT
    e.*,
    bz.total_population AS billing_zip_population,
    bz.median_household_income AS billing_zip_median_income,
    bz.poverty_rate AS billing_zip_poverty_rate,
    bz.medicaid_rate AS billing_zip_medicaid_rate,
    bz.urbanicity AS billing_zip_urbanicity,
    bz.pop_tier AS billing_zip_pop_tier,
    bz.income_bracket AS billing_zip_income_bracket,
    bz.poverty_tier AS billing_zip_poverty_tier,
    bz.medicaid_tier AS billing_zip_medicaid_tier,
    bz.high_poverty_flag AS billing_zip_high_poverty,
    sz.total_population AS servicing_zip_population,
    sz.median_household_income AS servicing_zip_median_income,
    sz.poverty_rate AS servicing_zip_poverty_rate,
    sz.medicaid_rate AS servicing_zip_medicaid_rate,
    sz.urbanicity AS servicing_zip_urbanicity,
    sz.pop_tier AS servicing_zip_pop_tier,
    sz.income_bracket AS servicing_zip_income_bracket,
    sz.poverty_tier AS servicing_zip_poverty_tier,
    sz.medicaid_tier AS servicing_zip_medicaid_tier,
    sz.high_poverty_flag AS servicing_zip_high_poverty
  FROM exclusions e
  LEFT JOIN {{ ref "zcta_demographics" }} bz ON e.billing_provider_zip = bz.zcta
  LEFT JOIN {{ ref "zcta_demographics" }} sz ON e.servicing_provider_zip = sz.zcta
