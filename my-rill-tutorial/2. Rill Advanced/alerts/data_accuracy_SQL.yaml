type: alert

display_name: SQL query Status Alert
#title:

# Check the alert every 1st of the month.
refresh:
  cron: "0 1 0 * *"
  disable: true # completely disable the resource (without deleting it)
  ref_update: false # don't refresh when a dependency is refreshed

watermark: inherit

intervals:
  duration: 'P3D'
#  limit: 5
#  check_unclosed: true

#timeout: 60

# Query for all resources with a reconcile error.
# The alert will trigger when the query result is not empty.
# Using a point in time in the past, will allow you to ensure that you data is accurate even with more modeling.
data:
  connector: duckdb
  sql: >
      SELECT 
        'Expected 196 added lines, got ' || SUM(added_lines) AS error_message
      FROM CH_incremental_joined_model
      WHERE CAST(author_date as DATE) = '2024-10-18'
        AND author_name = 'Alexey Milovidov'
      GROUP BY author_name
      HAVING SUM(added_lines) != 196


on_recover: true
on_fail: true
on_error: true

renotify: true
renotify_after: 10s

# Send notifications by email or slack 
notify:
  email:
    recipients: [test_user@domain.com]
  slack:
    users: []
    channels: ['#your-slack-channel']

annotations: { "key":"pair" }